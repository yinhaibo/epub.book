// 检查操作系统名称
function detectOS() {
    var sUserAgent = navigator.userAgent;
    var isWin = (navigator.platform == "Win32") || (navigator.platform == "Windows");
    var isMac = (navigator.platform == "Mac68K") || (navigator.platform == "MacPPC") || (navigator.platform == "Macintosh") || (navigator.platform == "MacIntel");
    if (isMac) return "Mac";
    var isUnix = (navigator.platform == "X11") && !isWin && !isMac;
    if (isUnix) return "Unix";
    var isLinux = (String(navigator.platform).indexOf("Linux") > -1);
    if (isLinux) return "Linux";
    if (isWin) {
        return "Windows";
    }
    return "other";
}

function getBaseUrl() {
	var re = new RegExp(/^.*\//);
	var base = window.location.href;
	var items = base.split('?');
	if (items != undefined && items.length > 0){
		base = items[0];
	}
	return re.exec(base);
}

//获取url中的参数
function getUrlParam(name) {
	var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
	var r = window.location.search.substr(1).match(reg);  //匹配目标参数
	if (r != null) return unescape(r[2]); return null; //返回参数值
}

function formatDate(date, format) {   
    if (!date) return;   
    if (!format) format = "yyyy-MM-dd";   
    switch(typeof date) {   
        case "string":   
            date = new Date(date.replace(/-/, "/"));   
            break;   
        case "number":   
            date = new Date(date);   
            break;   
    }    
    if (!date instanceof Date) return;   
    var dict = {   
        "yyyy": date.getFullYear(),   
        "M": date.getMonth() + 1,   
        "d": date.getDate(),   
        "H": date.getHours(),   
        "m": date.getMinutes(),   
        "s": date.getSeconds(),   
        "MM": ("" + (date.getMonth() + 101)).substr(1),   
        "dd": ("" + (date.getDate() + 100)).substr(1),   
        "HH": ("" + (date.getHours() + 100)).substr(1),   
        "mm": ("" + (date.getMinutes() + 100)).substr(1),   
        "ss": ("" + (date.getSeconds() + 100)).substr(1)   
    };       
    return format.replace(/(yyyy|MM?|dd?|HH?|ss?|mm?)/g, function() {   
        return dict[arguments[0]];   
    });                   
}

////////////////////////////////////////////
// Depends: Cordova Crypto Helper Plugin

function cryptoHelper_generateKeyPair(successCallback){
	cordova.exec(
		function(result){
			if (successCallback) successCallback(result);
		}, null, 'cryptoHelper', 'generateKeyPair', []);
}

function cryptoHelper_getRandomValue(successCallback){
	cordova.exec(
		function(result){
			if (successCallback) successCallback(result);
		}, null, 'cryptoHelper', 'getRandomValue', [{length:32}]);
}

function cryptoHelper_encrypt(data, successCallback){
	cryptoHelper_generateKeyPair(function(keypair){
		var options = keypair;
		cryptoHelper_getRandomValue(function(value){
			options.nonce = value;
			options.data = data;
			cordova.exec(function(result){
				options.nonce = value;
				options.key = result;
				if (successCallback) successCallback(options);
			}, null, 'cryptoHelper', 'encrypt', [options]);
		});
	});
}

function cryptoHelper_decrypt(options, successCallback){
	cordova.exec(function(result){
		if (successCallback) successCallback(result);
	}, null, 'cryptoHelper', 'decrypt', [options]);
}